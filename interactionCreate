const { ModalBuilder, TextInputBuilder, TextInputStyle, ActionRowBuilder, EmbedBuilder, PermissionsBitField } = require('discord.js');
// IMPORTANTE: Ajuste o caminho abaixo para onde seu arquivo match.js est√°
const { activePickBans, refreshPB, IDS, MAP_POOL } = require('./comandos/match.js');

client.on('interactionCreate', async (interaction) => {
    const state = activePickBans.get(interaction.channelId);

    if (interaction.isButton()) {
        // ACEITAR MATCH
        if (interaction.customId === "bss_match_aceitar") {
            const iglAId = interaction.message.embeds[0].footer.text.split("ID:")[1];
            const nomeA = interaction.message.embeds[0].fields[0].value;

            const canal = await interaction.guild.channels.create({
                name: `match-${nomeA}`,
                parent: IDS.CATEGORIA_MATCH,
                permissionOverwrites: [
                    { id: interaction.guild.id, deny: [PermissionsBitField.Flags.ViewChannel] },
                    { id: iglAId, allow: [PermissionsBitField.Flags.ViewChannel, PermissionsBitField.Flags.SendMessages] },
                    { id: interaction.user.id, allow: [PermissionsBitField.Flags.ViewChannel, PermissionsBitField.Flags.SendMessages] },
                ],
            });

            const askB = await canal.send(`üõ°Ô∏è <@${interaction.user.id}>, **qual o nome da sua equipe?**`);
            const col = canal.createMessageCollector({ filter: (m) => m.author.id === interaction.user.id, max: 1 });
            
            col.on("collect", async (m) => {
                const embedPrivado = new EmbedBuilder().setTitle("ü§ù BSS | Match Confirmada").setColor("#1E90FF")
                    .addFields({ name: "Time A", value: nomeA, inline: true }, { name: "Time B", value: m.content, inline: true },
                               { name: "IGL A", value: `<@${iglAId}>`, inline: true }, { name: "IGL B", value: `<@${interaction.user.id}>`, inline: true });
                
                const row = new ActionRowBuilder().addComponents(
                    new ButtonBuilder().setCustomId("pb_start").setLabel("Iniciar Pick/Ban").setStyle(1),
                    new ButtonBuilder().setCustomId("match_result").setLabel("Resultado").setStyle(3),
                    new ButtonBuilder().setCustomId("match_cancel").setLabel("Cancelar").setStyle(4)
                );
                await canal.send({ content: `<@${iglAId}> <@${interaction.user.id}>`, embeds: [embedPrivado], components: [row] });
                m.delete().catch(() => {}); askB.delete().catch(() => {});
            });
            return interaction.reply({ content: "Canal criado!", ephemeral: true });
        }

        // INICIAR PICKBAN
        if (interaction.customId === "pb_start") {
            const emb = interaction.message.embeds[0];
            const stateData = {
                iglA: emb.fields[2].value.match(/\d+/)[0], iglB: emb.fields[3].value.match(/\d+/)[0],
                timeA: emb.fields[0].value, timeB: emb.fields[1].value,
                bans: [], picks: [], pool: [...MAP_POOL], logs: [], statusLado: false, ultimoPick: ""
            };
            stateData.turno = Math.random() < 0.5 ? stateData.iglA : stateData.iglB;
            activePickBans.set(interaction.channelId, stateData);
            await interaction.message.delete().catch(() => {});
            return refreshPB(interaction.channel, stateData);
        }

        if (!state) return;

        // BOT√ïES DE MAPAS
        if (interaction.customId.startsWith("pb_")) {
            if (interaction.user.id !== state.turno || state.statusLado) return;
            const mapa = interaction.customId.replace("pb_", "");
            state.pool = state.pool.filter(m => m !== mapa);

            if (state.bans.length < 4) {
                state.bans.push(mapa);
                state.logs.push(`‚ùå <@${interaction.user.id}> baniu **${mapa}**`);
                state.turno = (state.turno === state.iglA ? state.iglB : state.iglA);
            } else {
                state.picks.push(mapa);
                state.logs.push(`‚úÖ <@${interaction.user.id}> pickou **${mapa}**`);
                state.ultimoPick = interaction.user.id;
                state.statusLado = true;
                state.turno = (interaction.user.id === state.iglA ? state.iglB : state.iglA);
            }
            await interaction.deferUpdate();
            return refreshPB(interaction.channel, state);
        }

        // ESCOLHA DE LADO (CORRIGE O TURNO PARA N√ÉO PICKAR DUAS VEZES)
        if (interaction.customId.startsWith("side_")) {
            if (interaction.user.id !== state.turno) return;
            const lado = interaction.customId === "side_CT" ? "CT" : "TR";
            state.logs.push(`‚û°Ô∏è <@${interaction.user.id}> come√ßa de **${lado}** em **${state.picks[state.picks.length-1]}**`);
            state.statusLado = false;
            state.turno = (state.ultimoPick === state.iglA ? state.iglB : state.iglA);
            await interaction.deferUpdate();
            return refreshPB(interaction.channel, state);
        }

        // CHAMAR MODAL DE RESULTADO
        if (interaction.customId === "match_result") {
            const modal = new ModalBuilder().setCustomId("res_modal").setTitle("üèÜ Relat√≥rio BSS");
            modal.addComponents(
                new ActionRowBuilder().addComponents(new TextInputBuilder().setCustomId("v").setLabel("VENCEDOR").setStyle(1).setRequired(true)),
                new ActionRowBuilder().addComponents(new TextInputBuilder().setCustomId("p").setLabel("PERDEDOR").setStyle(1).setRequired(true)),
                new ActionRowBuilder().addComponents(new TextInputBuilder().setCustomId("pl").setLabel("PLACAR").setStyle(2).setRequired(true))
            );
            return await interaction.showModal(modal);
        }
    }

    // SUBMIT DO MODAL
    if (interaction.isModalSubmit() && interaction.customId === "res_modal") {
        const v = interaction.fields.getTextInputValue("v");
        const p = interaction.fields.getTextInputValue("p");
        const pl = interaction.fields.getTextInputValue("pl");

        const embedRes = new EmbedBuilder().setColor("#00FF00").setTitle("üèÜ RESULTADO")
            .setDescription(`A equipe **${v}** venceu a equipe **${p}**!`)
            .addFields({ name: "üìä Placar", value: `\`\`\`${pl}\`\`\`` });

        const canalRes = await client.channels.fetch(IDS.RESULTADOS);
        await canalRes.send({ embeds: [embedRes] });
        await interaction.reply({ content: "‚úÖ Resultado enviado!", ephemeral: true });
        setTimeout(() => interaction.channel.delete().catch(() => {}), 10000);
    }
});
